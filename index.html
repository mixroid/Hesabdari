<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ø³ÛŒØ³ØªÙ… ÙØ±ÙˆØ´ Ø¨Ø§ Ú¯ÙØªØ§Ø±</title>
<style>
body{
  font-family:sans-serif;
  direction:rtl;
  margin:0;
  padding:0;
  background:#121212;
  color:#fff;
  display:flex;
  flex-direction:column;
  height:100vh;
}
h2{text-align:center;color:#bb86fc;margin:20px 0;}
#totals{display:flex;justify-content:center;gap:20px;margin-bottom:10px;}
.total-box{background:#1e1e1e;padding:20px;border-radius:12px;font-weight:700;font-size:1.2rem;text-align:center;width:180px;}
#buyTotal{color:#ffb74d;}
#sellTotal{color:#03dac6;}
#speechArea{text-align:center;margin-bottom:10px;}
#speechLabel{font-weight:700;font-size:1.3rem;display:block;margin-bottom:5px;text-align:center;}
#spokenText{font-weight:700;color:#ffb74d;font-size:1.4rem;margin-bottom:5px;display:block;text-align:center;}
#status{font-weight:700;font-size:1.2rem;color:#03dac6;margin-bottom:15px;text-align:center;}
#tableWrapper{
  border:2px solid #ff0000;
  border-radius:12px;
  overflow-y:auto;
  padding:10px;
  margin:0 20px;
  background:#1e1e1e;
  flex:1;
}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ffd700;padding:12px;text-align:center;font-size:1.4rem;color:#fff;}
th{background:#2a2a2a;font-weight:600;}
tr:hover td{background:#333;}
.action-btn{padding:10px 18px;font-size:1rem;border-radius:12px;margin:0 6px;}
.edit{background:#ffeb3b;color:#000;}
.delete{background:#f44336;color:#fff;}
#bottomBar{
  flex-shrink:0;
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:20px;
  background: rgba(255,192,203,0.3);
  border-top:2px solid red;
  padding:20px 10px;
  z-index:1000;
}
#buttonGrid{display:grid;grid-template-columns: repeat(2,1fr);grid-template-rows: repeat(2,1fr);gap:20px;width:calc(100% - 40px);}
.bottomBtn{padding:27px 0;font-size:1.6rem;font-weight:700;border-radius:24px;width:100%;text-align:center;}
#startBtn{background:#00ff57;color:#000;}
#stopBtn{background:#ff1744;color:#000;}
#clearBtn{background:#3700b3;color:#fff;}
#reportBtn{background:#ffeb3b;color:#000;}
</style>
</head>
<body>
<h2>Ø³ÛŒØ³ØªÙ… ÙØ±ÙˆØ´ Ø¯Ø®Ø§Ù†ÛŒØ§Øª Ù†ØµØ±ÛŒ </h2>

<div id="totals">
  <div class="total-box" id="buyTotal">Ø¬Ù…Ø¹ Ø®Ø±ÛŒØ¯: 0</div>
  <div class="total-box" id="sellTotal">Ø¬Ù…Ø¹ ÙØ±ÙˆØ´: 0</div>
</div>

<div id="speechArea">
  <span id="speechLabel">Ú¯ÙØªØ§Ø±:</span>
  <span id="spokenText"></span>
  <div id="status">Ø¢Ù…Ø§Ø¯Ù‡</div>
</div>

<div id="tableWrapper">
  <table>
    <thead>
      <tr>
        <th>Ù†ÙˆØ¹</th>
        <th>Ù‚ÛŒÙ…Øª</th>
        <th>Ú©Ø§Ù„Ø§</th>
        <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="bottomBar">
  <div id="buttonGrid">
    <button id="startBtn" class="bottomBtn">ğŸ¤ Ø¶Ø¨Ø·</button>
    <button id="stopBtn" class="bottomBtn" disabled>â¹ ØªÙˆÙ‚Ù</button>
    <button id="reportBtn" class="bottomBtn">ğŸ–¨ï¸ Ú¯Ø²Ø§Ø±Ø´ Ú¯ÛŒØ±ÛŒ</button>
    <button id="clearBtn" class="bottomBtn">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
// Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ø°Ø®ÛŒØ±Ù‡
let records=JSON.parse(localStorage.getItem("records")||"[]");
const tbody=document.getElementById("tbody");
const status=document.getElementById("status");
const spokenText=document.getElementById("spokenText");
const buyTotalDiv=document.getElementById("buyTotal");
const sellTotalDiv=document.getElementById("sellTotal");
function save(){localStorage.setItem("records",JSON.stringify(records));}
const fmt=n=>n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".");

// Ø¬Ù…Ø¹ Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´
function updateTotals(){
  let buySum=0,sellSum=0;
  records.forEach(r=>{if(r.Ù†ÙˆØ¹==="Ø®Ø±ÛŒØ¯") buySum+=r.Ù‚ÛŒÙ…Øª; else if(r.Ù†ÙˆØ¹==="ÙØ±ÙˆØ´") sellSum+=r.Ù‚ÛŒÙ…Øª;});
  buyTotalDiv.innerText=`Ø¬Ù…Ø¹ Ø®Ø±ÛŒØ¯: ${fmt(buySum)}`;
  sellTotalDiv.innerText=`Ø¬Ù…Ø¹ ÙØ±ÙˆØ´: ${fmt(sellSum)}`;
}

// Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„
function render(){
  tbody.innerHTML="";
  records.forEach((r,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${r.Ù†ÙˆØ¹}</td>
      <td>${fmt(r.Ù‚ÛŒÙ…Øª)}</td>
      <td>${r.Ú©Ø§Ù„Ø§}</td>
      <td>
        <button class="action-btn edit" data-i="${i}">âœï¸</button>
        <button class="action-btn delete" data-i="${i}">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  });
  updateTotals();
  const tw=document.getElementById("tableWrapper");
  tw.scrollTop = tw.scrollHeight;
}
render();

// Ø­Ø°Ù Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´
tbody.onclick=e=>{
  const i=e.target.dataset.i;
  if(i==null) return;
  if(e.target.classList.contains("delete")){
    records.splice(i,1); save(); render(); status.innerText="Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯ âœ…";
  }
  if(e.target.classList.contains("edit")){
    let r=records[i];
    let Ù†ÙˆØ¹=prompt("Ù†ÙˆØ¹",r.Ù†ÙˆØ¹);
    let Ù‚ÛŒÙ…Øª=prompt("Ù‚ÛŒÙ…Øª",r.Ù‚ÛŒÙ…Øª);
    let Ú©Ø§Ù„Ø§=prompt("Ú©Ø§Ù„Ø§",r.Ú©Ø§Ù„Ø§);
    if(Ù†ÙˆØ¹ && Ù‚ÛŒÙ…Øª && Ú©Ø§Ù„Ø§){records[i]={Ù†ÙˆØ¹,Ù‚ÛŒÙ…Øª:Number(Ù‚ÛŒÙ…Øª),Ú©Ø§Ù„Ø§}; save(); render(); status.innerText="Ø±Ú©ÙˆØ±Ø¯ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯ âœ…";}
  }
};
document.getElementById("clearBtn").onclick=()=>{
  if(confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú©Ù„ Ø¬Ø¯ÙˆÙ„ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")){records=[]; save(); render(); status.innerText="Ø¬Ø¯ÙˆÙ„ Ù¾Ø§Ú© Ø´Ø¯ âœ…";}
};

// Ø¶Ø¨Ø· ØµØ¯Ø§
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
if(!SR){alert("SpeechRecognition Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯!");}
const rec=new SR();
rec.lang="fa-IR"; rec.continuous=true; rec.interimResults=false;

function mapDigits(s){return s.replace(/[Û°-Û¹]/g,d=>"Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d));}
const wordNums={"ÛŒÚ©":1,"Ø¯Ùˆ":2,"Ø³Ù‡":3,"Ú†Ù‡Ø§Ø±":4,"Ù¾Ù†Ø¬":5,"Ø´Ø´":6,"Ù‡ÙØª":7,"Ù‡Ø´Øª":8,"Ù†Ù‡":9,"Ø¯Ù‡":10};
function extractPrice(text){
  text=mapDigits(text);
  let m=text.match(/(\d[\d\s]*)\s*(?:ØªÙˆÙ…Ø§Ù†|ØªÙˆÙ…Ù†)/);
  if(m) return parseInt(m[1].replace(/\s/g,""));
  let mil=text.match(/(ÛŒÚ©|Ø¯Ùˆ|Ø³Ù‡|Ú†Ù‡Ø§Ø±|Ù¾Ù†Ø¬|Ø´Ø´|Ù‡ÙØª|Ù‡Ø´Øª|Ù†Ù‡|Ø¯Ù‡|\d+)\s+Ù…ÛŒÙ„ÛŒÙˆÙ†/);
  let thou=text.match(/(ÛŒÚ©|Ø¯Ùˆ|Ø³Ù‡|Ú†Ù‡Ø§Ø±|Ù¾Ù†Ø¬|Ø´Ø´|Ù‡ÙØª|Ù‡Ø´Øª|Ù†Ù‡|Ø¯Ù‡|\d+)\s+Ù‡Ø²Ø§Ø±/);
  let total=0;
  if(mil){let n=mil[1]; total+=(wordNums[n]||parseInt(n))*1000000;}
  if(thou){let n=thou[1]; total+=(wordNums[n]||parseInt(n))*1000;}
  return total||null;
}

// Ú©Ù†ØªØ±Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
const startBtn=document.getElementById("startBtn");
const stopBtn=document.getElementById("stopBtn");

startBtn.onclick=()=>{
  try{
    rec.start();
    status.innerText="Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†...";
    startBtn.disabled=true;
    stopBtn.disabled=false;
  }catch(err){
    status.innerText="Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø· âŒ";
    startBtn.disabled=false;
    stopBtn.disabled=true;
  }
};

stopBtn.onclick=()=>{
  try{
    rec.stop();
  }finally{
    startBtn.disabled=false;
    stopBtn.disabled=true;
    status.innerText="ØªÙˆÙ‚Ù Ø´Ø¯ â¹";
  }
};

rec.onend=()=>{
  startBtn.disabled=false;
  stopBtn.disabled=true;
};

rec.onresult=e=>{
  const res=e.results[e.results.length-1];
  if(!res.isFinal) return;
  const s=res[0].transcript.trim();
  spokenText.innerText=s;

  const Ù‚ÛŒÙ…Øª=extractPrice(s);
  if(!Ù‚ÛŒÙ…Øª){status.innerText="Ù‚ÛŒÙ…Øª ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯ âŒ"; return;}

  const Ù†ÙˆØ¹=s.includes("ÙØ±ÙˆØ®ØªÙ…")?"ÙØ±ÙˆØ´":s.includes("Ø®Ø±ÛŒØ¯Ù…")?"Ø®Ø±ÛŒØ¯":"Ù†Ø§Ù…Ø´Ø®Øµ";
  const Ú©Ø§Ù„Ø§=s.replace(/ÙØ±ÙˆØ®ØªÙ…|Ø®Ø±ÛŒØ¯Ù…|ØªÙˆÙ…Ø§Ù†|ØªÙˆÙ…Ù†/g,"").trim()||"Ø³Ø§ÛŒØ±";
  records.push({Ù†ÙˆØ¹,Ù‚ÛŒÙ…Øª,Ú©Ø§Ù„Ø§}); save(); render(); status.innerText="Ø«Ø¨Øª Ø´Ø¯ âœ…";
};

// Ú¯Ø²Ø§Ø±Ø´ Ú¯ÛŒØ±ÛŒ PDF Ø¨Ø§ html2canvas
document.getElementById("reportBtn").onclick = async () => {
  if(records.length===0){alert("Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!"); return;}
  
  // ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
  const dateObj = new Date();
  const dateStr = new Intl.DateTimeFormat('fa-IR-u-ca-persian',{year:'numeric',month:'2-digit',day:'2-digit'}).format(dateObj).replace(/\//g, '-');

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ù…Ø¹ Ú©Ù„
  const buySum = records.filter(r=>r.Ù†ÙˆØ¹==="Ø®Ø±ÛŒØ¯").reduce((a,b)=>a+b.Ù‚ÛŒÙ…Øª,0);
  const sellSum = records.filter(r=>r.Ù†ÙˆØ¹==="ÙØ±ÙˆØ´").reduce((a,b)=>a+b.Ù‚ÛŒÙ…Øª,0);

  const perPage = 20;
  const pages = Math.ceil(records.length / perPage);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'portrait',
    unit: 'mm',
    format: 'a4'
  });

  for(let p=0; p<pages; p++){
    const start = p*perPage;
    const end = start+perPage;
    const chunk = records.slice(start,end);

    const chunkBuySum = chunk.filter(r=>r.Ù†ÙˆØ¹==="Ø®Ø±ÛŒØ¯").reduce((a,b)=>a+b.Ù‚ÛŒÙ…Øª,0);
    const chunkSellSum = chunk.filter(r=>r.Ù†ÙˆØ¹==="ÙØ±ÙˆØ´").reduce((a,b)=>a+b.Ù‚ÛŒÙ…Øª,0);

    const reportDiv = document.createElement("div");
    reportDiv.style.width="794px";
    reportDiv.style.minHeight="1123px";
    reportDiv.style.background="#fff";
    reportDiv.style.padding="40px";
    reportDiv.style.boxSizing="border-box";
    reportDiv.style.fontFamily="sans-serif";
    reportDiv.style.color="#000";
    reportDiv.style.position="fixed";
    reportDiv.style.left="-10000px";
    document.body.appendChild(reportDiv);

    let html = `<div style="display:flex;justify-content:space-between;margin-bottom:20px;font-size:18px;font-weight:bold;">
      <div>Ø¬Ù…Ø¹ Ø®Ø±ÛŒØ¯: ${fmt(chunkBuySum)}</div>
      <div>Ø¬Ù…Ø¹ ÙØ±ÙˆØ´: ${fmt(chunkSellSum)}</div>
      <div>ØªØ§Ø±ÛŒØ®: ${dateStr}</div>
    </div>`;

    html += `<table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th style="background:#000;color:#fff;border:1px solid #000;padding:8px;">Ù†ÙˆØ¹</th>
          <th style="background:#000;color:#fff;border:1px solid #000;padding:8px;">Ù‚ÛŒÙ…Øª</th>
          <th style="background:#000;color:#fff;border:1px solid #000;padding:8px;">Ú©Ø§Ù„Ø§</th>
        </tr>
      </thead>
      <tbody>`;
    chunk.forEach(r=>{
      html += `<tr>
        <td style="border:1px solid #000;padding:6px;text-align:center;color:#000;">${r.Ù†ÙˆØ¹}</td>
        <td style="border:1px solid #000;padding:6px;text-align:center;color:#000;">${fmt(r.Ù‚ÛŒÙ…Øª)}</td>
        <td style="border:1px solid #000;padding:6px;text-align:center;color:#000;">${r.Ú©Ø§Ù„Ø§}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    if(pages > 1){
      html += `<div style="text-align:center;margin-top:10px;font-weight:bold;">ØµÙØ­Ù‡ ${p+1} Ø§Ø² ${pages}</div>`;
    }
    reportDiv.innerHTML = html;

    const canvas = await html2canvas(reportDiv, {scale: 2});
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    
    if(p > 0) doc.addPage();
    
    const imgWidth = 210;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
    
    document.body.removeChild(reportDiv);
  }

  doc.save(`${dateStr}.pdf`);
  status.innerText="Ú¯Ø²Ø§Ø±Ø´ PDF Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…";
};
</script>
</body>
</html>
